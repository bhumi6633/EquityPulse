<!DOCTYPE html>
<html lang="en" class="transition-all duration-300">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WStreet Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    if (localStorage.getItem('theme') === 'dark') {
      document.documentElement.classList.add('dark');
    }
  </script>
  <style>
    body {
      background-color: #0a0a0a;
    }
    canvas {
      background-color: #1a1a1a;
    }
  </style>
</head>
<body class="text-white font-mono min-h-screen flex flex-col items-center justify-center p-6">

  <button onclick="toggleTheme()" class="absolute top-4 right-4 text-sm text-gray-400 hover:text-yellow-300">
    ðŸ•¶ Terminal Mode
  </button>

  <div class="bg-black p-6 rounded-lg shadow-lg border border-yellow-600 w-full max-w-md text-center">
    <img src="/static/logo.png" alt="Wall Street Logo" class="mx-auto mb-4 w-16 h-16">
    <h1 class="text-3xl font-extrabold text-yellow-400 mb-2 tracking-wider">ðŸ’¹EquityPulse</h1>
    <p class="text-xs text-gray-500 mb-4">Live Market Intelligence. Inspired by Wall Street.</p>

    <input id="stock-symbol" type="text" placeholder="Enter symbol (e.g., AAPL)"
           class="w-full p-2 bg-gray-900 text-white border border-gray-600 rounded focus:outline-none focus:ring-2 focus:ring-yellow-400">

    <button onclick="getStockPrice()" class="mt-4 w-full bg-yellow-400 hover:bg-yellow-500 text-black font-bold p-2 rounded">
      Track Stock
    </button>

    <div id="stock-result" class="mt-6 text-lg font-medium"></div>
    <canvas id="price-chart" class="mt-6 w-full h-64 hidden rounded"></canvas>
    <div id="recent-searches" class="mt-6 text-sm text-left"></div>
  </div>

  <script>
    let chart = null;

    function toggleTheme() {
      const html = document.documentElement;
      html.classList.toggle('dark');
      localStorage.setItem('theme', html.classList.contains('dark') ? 'dark' : 'light');
    }

    function renderChart(labels, data) {
      const ctx = document.getElementById("price-chart").getContext("2d");
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Price ($)',
            data: data,
            borderColor: '#facc15',
            backgroundColor: 'rgba(250,204,21,0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          plugins: {
            legend: { labels: { color: '#facc15' } }
          },
          scales: {
            x: { ticks: { color: '#facc15' } },
            y: { ticks: { color: '#facc15' } }
          }
        }
      });
      $("#price-chart").removeClass("hidden");
    }

    function getStockPrice() {
      const symbol = $("#stock-symbol").val().trim();
      if (!symbol) return alert("Please enter a stock symbol.");
      updateRecentSearches(symbol);

      $.post("/get_price", { symbol }, function(data) {
        if (data.error) {
          $("#stock-result").html(`<span class="text-red-500">${data.error}</span>`);
        } else {
          const changeClass = data.change >= 0 ? "text-green-400" : "text-red-500";
          const sign = data.change >= 0 ? "+" : "";
          $("#stock-result").html(`
            <div>
              <div class="font-bold text-yellow-400">ðŸ’¼ ${data.name} (${data.symbol})</div>
              <div class="text-3xl text-yellow-200 mt-1">$${data.price}</div>
              <div class="mt-1 ${changeClass} text-sm">
                ${sign}${data.change} (${sign}${data.percent_change}%)
              </div>
            </div>
          `);
          $.post("/get_history", { symbol }, function(histData) {
            if (!histData.error) {
              renderChart(histData.dates, histData.prices);
            }
          });
        }
      });
    }

    function updateRecentSearches(symbol) {
      let history = JSON.parse(localStorage.getItem("searchHistory") || "[]");
      symbol = symbol.toUpperCase();
      history = [symbol, ...history.filter(s => s !== symbol)].slice(0, 5);
      localStorage.setItem("searchHistory", JSON.stringify(history));
      renderRecentSearches();
    }

    function renderRecentSearches() {
      const history = JSON.parse(localStorage.getItem("searchHistory") || "[]");
      if (history.length) {
        $("#recent-searches").html(`
          <div class="text-yellow-400 font-bold mb-1">ðŸ•° Recent Tickers</div>
          <ul class="list-disc list-inside space-y-1">
            ${history.map(s => `<li class="cursor-pointer text-yellow-200 hover:underline" onclick="reSearch('${s}')">${s}</li>`).join("")}
          </ul>
        `);
      }
    }

    function reSearch(symbol) {
      $("#stock-symbol").val(symbol);
      getStockPrice();
    }

    $(document).ready(() => renderRecentSearches());
  </script>

</body>
</html>
